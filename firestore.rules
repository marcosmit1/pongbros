rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    function isGameParticipant(gameData) {
      return isAuthenticated() && 
        (request.auth.uid in gameData.team1.players || 
         request.auth.uid in gameData.team2.players ||
         gameData.team1.players.hasAny([request.auth.uid + '@guest']) ||
         gameData.team2.players.hasAny([request.auth.uid + '@guest']));
    }

    function isTournamentParticipant(tournamentData) {
      return request.auth.uid in tournamentData.participants ||
             tournamentData.participants.hasAny([request.auth.uid + '@guest']);
    }

    function isVenueOwner(venueId) {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/venues/$(venueId)).data.ownerId == request.auth.uid;
    }

    // Games collection
    match /games/{gameId} {
      allow read: if 
        (resource.data.isPartOfTournament && 
         isTournamentParticipant(get(/databases/$(database)/documents/tournaments/$(resource.data.tournamentId)).data)) ||
        isGameParticipant(resource.data);
      allow create: if isAuthenticated();
      allow update: if 
        (resource.data.isPartOfTournament && 
         isTournamentParticipant(get(/databases/$(database)/documents/tournaments/$(resource.data.tournamentId)).data)) ||
        isGameParticipant(resource.data);
      allow delete: if isGameParticipant(resource.data);
    }

    // User profiles
    match /users/{userId} {
      allow read: if true;  // This will allow username checks
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && (
        // Allow users to update their own profile, including profile image
        (request.auth.uid == userId && 
         (request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['profileImageURL', 'username', 'email', 'name']))) || 
        // Allow admins to update admin status
        (isAdmin() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isAdmin']))
      );
      
      match /friends/{friendId} {
        allow read, write: if isAuthenticated() && 
          (request.auth.uid == userId || request.auth.uid == friendId);
      }
      
      match /friendRequests/{requestId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;
        allow write: if isAuthenticated();
      }
    }

    // User stats
    match /userStats/{userId} {
      allow read, write: if isAuthenticated();
    }

    // Regular tournaments
    match /tournaments/{tournamentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        (isTournamentParticipant(resource.data) || 
         resource.data.createdBy == request.auth.uid);
      
      match /presence/{userId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && request.auth.uid == userId;
      }
      
      match /matches/{matchId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && 
          isTournamentParticipant(get(/databases/$(database)/documents/tournaments/$(tournamentId)).data);
      }
    }

    // Client tournaments (venue-hosted tournaments)
    match /client_tournaments/{tournamentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.createdBy || // Tournament creator can do anything
        (
          // Allow team creation/updates for any authenticated user
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['teams', 'participants', 'updatedAt']) &&
          // Basic security checks:
          // 1. User must be part of the team they're adding
          // 2. User must not be in any existing teams
          // 3. Tournament must not be full
          request.auth.uid in request.resource.data.teams[request.resource.data.teams.size() - 1].players &&
          (!('teams' in resource.data) || 
            !resource.data.teams.hasAll([request.auth.uid])) &&
          (!('maxTeams' in resource.data) || 
           !('teams' in resource.data) || 
           resource.data.teams.size() < resource.data.maxTeams)
        ) ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt']) // Allow status updates for tournament creator
      );
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.createdBy;
    }

    // Presence
    match /presence/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }

    // Venue management
    match /venues/{venueId} {
      // Allow public read access to venues
      allow read: if true;
      
      // Allow creation of venues by any authenticated user
      allow create: if isAuthenticated() && 
                   request.resource.data.ownerId == request.auth.uid &&
                   request.resource.data.keys().hasAll([
                     'name', 'address', 'description', 'capacity',
                     'pricePerHour', 'openingHours', 'location', 'ownerId'
                   ]);
      
      // Allow venues to be updated by their owners or admins
      allow update: if isAuthenticated() && (
        isAdmin() ||
        (resource.data.ownerId == request.auth.uid &&
         request.resource.data.ownerId == request.auth.uid)
      );
                   
      // Allow venues to be deleted by their owners or admins
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.ownerId == request.auth.uid
      );
    }

    // Bookings collection
    match /bookings/{bookingId} {
      // Allow read access to:
      // 1. The user who made the booking
      // 2. The venue owner of the booking
      // 3. Admins
      allow read: if isAuthenticated() && (
        request.auth.uid == resource.data.userId ||
        request.auth.uid == resource.data.venueId ||
        isAdmin()
      );
      
      // Allow creation of bookings by any authenticated user
      allow create: if isAuthenticated() &&
                   request.resource.data.keys().hasAll([
                     'venueId', 'userId', 'tableNumber', 
                     'date', 'duration', 'status'
                   ]);
      
      // Allow updates:
      // 1. By the user who made the booking
      // 2. By the venue owner (but only the status field)
      // 3. By admins
      allow update: if isAuthenticated() && (
        request.auth.uid == resource.data.userId ||
        (request.auth.uid == resource.data.venueId && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status'])) ||
        isAdmin()
      );
      
      // Allow deletion by the booking user or admins
      allow delete: if isAuthenticated() && 
        (request.auth.uid == resource.data.userId || isAdmin());
    }
  }
} 